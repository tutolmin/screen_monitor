import os
from chromadb.config import Settings
from langchain_gigachat.embeddings.gigachat import GigaChatEmbeddings
from langchain_chroma import Chroma

# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
if "GIGACHAT_CREDENTIALS" not in os.environ:
    print("‚ùå –û—à–∏–±–∫–∞: GIGACHAT_CREDENTIALS –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞")
    exit(1)

from langchain_gigachat.chat_models import GigaChat
from langchain.schema import HumanMessage

giga = GigaChat(
    credentials=os.environ["GIGACHAT_CREDENTIALS"],
    model="GigaChat-Max",
    verify_ssl_certs=False,
    timeout=1200,
)


# –ë–î –¥–ª—è –≤–µ–±–∏–Ω–∞—Ä–æ–≤


# –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ –∂–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–∏, —á—Ç–æ –∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±–∞–∑—ã
embeddings = GigaChatEmbeddings(
    credentials=os.environ["GIGACHAT_CREDENTIALS"],
    verify_ssl_certs=False
)

persist_directory = "./chroma_db_u_web"

# –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–∑—É
db = Chroma(
    persist_directory=persist_directory,
    embedding_function=embeddings
)

# –õ–ò–°–¢–ò–ù–ì –í–°–ï–• –ß–ê–ù–ö–û–í
print("=" * 80)
print("üìã –õ–ò–°–¢–ò–ù–ì –í–°–ï–• –ß–ê–ù–ö–û–í –í –ë–ê–ó–ï:")
print("=" * 80)

try:
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —á–∞–Ω–∫–∏ –∏–∑ –±–∞–∑—ã
    all_data = db.get()

    if all_data and 'documents' in all_data and len(all_data['documents']) > 0:
        total_chunks = len(all_data['documents'])
        print(f"‚úÖ –í—Å–µ–≥–æ —á–∞–Ω–∫–æ–≤ –≤ –±–∞–∑–µ: {total_chunks}")
        print("-" * 80)

        for i, (doc_content, metadata, doc_id) in enumerate(zip(
            all_data['documents'],
            all_data['metadatas'],
            all_data['ids']
        )):
            print(f"üéØ –ß–ê–ù–ö #{i+1}")
            print(f"   ID: {doc_id}")
#            print(f"   –°–æ–¥–µ—Ä–∂–∏–º–æ–µ: {doc_content}")
            print(f"   –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ: {metadata}")
            print(f"   –î–ª–∏–Ω–∞: {len(doc_content)} —Å–∏–º–≤–æ–ª–æ–≤")
            print("-" * 80)

    else:
        print("‚ùå –í –±–∞–∑–µ –Ω–µ—Ç —á–∞–Ω–∫–æ–≤ –∏–ª–∏ –±–∞–∑–∞ –ø—É—Å—Ç–∞")

except Exception as e:
    print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —á–∞–Ω–∫–æ–≤: {e}")

# –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ –∂–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–∏, —á—Ç–æ –∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±–∞–∑—ã
embeddings_pres = GigaChatEmbeddings(
    credentials=os.environ["GIGACHAT_CREDENTIALS"],
    verify_ssl_certs=False
)

# –ë–î –¥–ª—è –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–π

persist_directory = "./chroma_db_u_pres"

# –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–∑—É
db_pres = Chroma(
    persist_directory=persist_directory,
    embedding_function=embeddings_pres
)

# –õ–ò–°–¢–ò–ù–ì –í–°–ï–• –ß–ê–ù–ö–û–í
print("=" * 80)
print("üìã –õ–ò–°–¢–ò–ù–ì –í–°–ï–• –ß–ê–ù–ö–û–í –í –ë–ê–ó–ï:")
print("=" * 80)

try:
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —á–∞–Ω–∫–∏ –∏–∑ –±–∞–∑—ã
    all_data = db_pres.get()

    if all_data and 'documents' in all_data and len(all_data['documents']) > 0:
        total_chunks = len(all_data['documents'])
        print(f"‚úÖ –í—Å–µ–≥–æ —á–∞–Ω–∫–æ–≤ –≤ –±–∞–∑–µ: {total_chunks}")
        print("-" * 80)

        for i, (doc_content, metadata, doc_id) in enumerate(zip(
            all_data['documents'],
            all_data['metadatas'],
            all_data['ids']
        )):
            print(f"üéØ –ß–ê–ù–ö #{i+1}")
            print(f"   ID: {doc_id}")
#            print(f"   –°–æ–¥–µ—Ä–∂–∏–º–æ–µ: {doc_content}")
            print(f"   –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ: {metadata}")
            print(f"   –î–ª–∏–Ω–∞: {len(doc_content)} —Å–∏–º–≤–æ–ª–æ–≤")
            print("-" * 80)

    else:
        print("‚ùå –í –±–∞–∑–µ –Ω–µ—Ç —á–∞–Ω–∫–æ–≤ –∏–ª–∏ –±–∞–∑–∞ –ø—É—Å—Ç–∞")

except Exception as e:
    print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —á–∞–Ω–∫–æ–≤: {e}")

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–∏—Å–∫
print("\nüîç –¢–ï–°–¢–ò–†–£–ï–ú –ü–û–ò–°–ö:")
try:
    if all_data and 'documents' in all_data and len(all_data['documents']) > 0:
        # –ë–µ—Ä–µ–º —á–∞—Å—Ç—å –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —á–∞–Ω–∫–∞ –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
#        first_chunk_content = all_data['documents'][0]
#        test_query = first_chunk_content[:50] + "..."
#        test_query = "–Ω–∞–∏–≤–Ω—ã–π"
#        test_query = "–ª—é–±–æ–∑–Ω–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å"
#        test_query = "–ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω–æ–π –∞–≥—Ä–µ—Å—Å–∏–∏ –º–æ–∂–Ω–æ –æ—Ç–Ω–µ—Å—Ç–∏ (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä):"
        test_query = """
–°–ë–ï–†
–£–ù–ò–í–ï–†–°–ò–¢–ï–¢
–°–±–µ—Ä –ú–∏–Ω–∏-–ú–í–ê 16 –ø–æ—Ç–æ–∫ –≠–∫–∑–∞–º–µ–Ω –ø–æ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–µ "–ö–æ–º–º—É
–ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω–æ–π –∞–≥—Ä–µ—Å—Å–∏–∏ –º–æ–∂–Ω–æ –æ—Ç–Ω–µ—Å—Ç–∏ (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä):
–ù–∞–ø–æ—Ä–∏—Å—Ç–æ—Å—Ç—å
–ù–µ—É—Å—Ç—É–ø—á–∏–≤–æ—Å—Ç—å
–õ—é–±–æ–∑–Ω–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
–ù–µ—Ç–µ—Ä–ø–∏–º–æ—Å—Ç—å
"""

        test_query = """
–ü–µ—Ä–µ–≥–æ–≤–æ—Ä–Ω–∞—è –∫–∞—Ä—Ç–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä):
–¢–∞–∫—Ç–∏—á–µ—Å–∫–∞—è
B
–ü–µ—Å—Ç—Ä–∞—è
–ù–∞–∏–≤–Ω–∞—è
–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è
"""

        test_query = """
–ß—Ç–æ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–Ω–æ–π —Å–∏–ª—ã (–º–Ω–æ—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä):
–°–∏–ª–∞ –∫–æ–∞–ª–∏—Ü–∏–∏
B
–°–∏–ª–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
–°–∏–ª–∞ —Å–∏—Ç—É–∞—Ü–∏–∏
D
–°–∏–ª–∞ –ª–∏—á–Ω–æ—Å—Ç–∏
–°–∏–ª–∞ –∑–¥—Ä–∞–≤–æ–≥–æ —Å–º—ã—Å–ª–∞
–°–∏–ª–∞ –¥–∞–≤–ª–µ–Ω–∏—è
"""

        test_query = """
–°–ò–¢–£–ê–¶–ò–Ø 1. –£ –ò–≥–æ—Ä—è –Ω–µ –±—ã–ª–æ –≤—Ä–µ–º–µ–Ω–∏, —á—Ç–æ–±—ã –ø—Ä–æ–π—Ç–∏ —Ç–µ—Ö–æ—Å–º–æ—Ç—Ä. –û–Ω –ø–æ—Ä—É—á–∏–ª —ç—Ç–æ —Å–≤–æ–µ–π –∂–µ–Ω–µ –ê–Ω–Ω–µ, –∫–æ—Ç–æ—Ä–∞—è –æ—á–µ–Ω—å –ª—é–±–∏—Ç –≤–æ–¥–∏—Ç—å –º–∞—à–∏–Ω—É, –Ω–æ –Ω–µ –ª—é–±–∏—Ç –µ—é –∑–∞–Ω–∏–º–∞—Ç—å—Å—è. –û–Ω–∞ –Ω–∏ —Ä–∞–∑—É –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏–ª–∞ —Ç–µ—Ö–æ—Å–º–æ—Ç—Ä. –û–Ω–∞ –Ω–µ —É—è—Å–Ω–∏–ª–∞ —É–∫–∞–∑–∞–Ω–∏—è –ò–≥–æ—Ä—è, –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–ª–∞ —Ç–µ—Ö–æ—Å–º–æ—Ç—Ä, 2 —Ä–∞–∑–∞ –æ–ø–∞–∑–¥—ã–≤–∞–ª–∞  –Ω–∞ –Ω–µ–≥–æ. –ê–Ω–Ω–∞ —Å—Ç–∞–ª–∞ —Ä–∞–∑–¥—Ä–∞–∂–∞—Ç—å—Å—è, –∫–æ–≥–¥–∞ –º—É–∂ –Ω–∞–ø–æ–º–∏–Ω–∞–ª –æ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–æ–º —Ç–µ—Ö–æ—Å–º–æ—Ç—Ä–µ. 
–û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ, –Ω–∞ –∫–∞–∫–æ–º —É—Ä–æ–≤–Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫? –í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∏–∑ —Å–ø–∏—Å–∫–∞:
D1
D2
D3
D4
"""

        test_query = """
–°–ò–¢–£–ê–¶–ò–Ø 2. –ú—É–∂ –ï–∫–∞—Ç–µ—Ä–∏–Ω—ã ‚Äì —Å–∞–Ω—Ç–µ—Ö–Ω–∏–∫ –ï–≤–≥–µ–Ω–∏–π. –ï–∫–∞—Ç–µ—Ä–∏–Ω–∞ –ø–æ–ø—Ä–æ—Å–∏–ª–∞ –µ–≥–æ –ø–æ—á–∏–Ω–∏—Ç—å —Å–º–µ—Å–∏—Ç–µ–ª—å –≤ —Ä–∞–∫–æ–≤–∏–Ω–µ –¥–æ–º–∞. –ï–≤–≥–µ–Ω–∏—é –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ä–∞–±–æ—Ç—É –¥–æ–º–∞ –Ω–µ —Ö–æ—á–µ—Ç—Å—è, –æ–Ω –ø—Ä–µ–¥–ª–æ–∂–∏–ª –ï–∫–∞—Ç–µ—Ä–∏–Ω–µ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å —Å–≤–æ–µ–≥–æ –∫–æ–ª–ª–µ–≥—É-—Å–∞–Ω—Ç–µ—Ö–Ω–∏–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–ª–∂–µ–Ω –ª—É—á—à–µ —Å–ø—Ä–∞–≤–∏—Ç—å—Å—è —Å –∑–∞–¥–∞–Ω–∏–µ–º, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –µ–≥–æ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –æ–Ω –Ω–µ —Ö–æ—á–µ—Ç —Ç—Ä–∞—Ç–∏—Ç—å –≤—Ä–µ–º—è –Ω–∞ —Ç–æ, —á—Ç–æ–±—ã —Ä–∞–∑–±–∏—Ä–∞—Ç—å—Å—è –≤ —ç—Ç–æ–º –≤–æ–ø—Ä–æ—Å–µ.
–û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ, –Ω–∞ –∫–∞–∫–æ–º —É—Ä–æ–≤–Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫? –í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∏–∑ —Å–ø–∏—Å–∫–∞:
D1
D2
D3
D4
"""

        test_query = """
–°–ò–¢–£–ê–¶–ò–Ø 3. –í–∞—à —Å—ã–Ω –°–∞—à–∞ 12 –ª–µ—Ç –∂–∞–∂–¥–µ—Ç —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏. –°–µ–≥–æ–¥–Ω—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω–æ —Å—ä–µ–∑–¥–∏—Ç—å –∫ –±–∞–±—É—à–∫–µ, –æ—Ç–≤–µ–∑—Ç–∏ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞, –∞ –í—ã –Ω–µ–∫—Å—Ç–∞—Ç–∏ –æ—á–µ–Ω—å –∑–∞–Ω—è—Ç—ã –Ω–∞ —Ä–∞–±–æ—Ç–µ. –°–∞—à–∞ –æ—á–µ–Ω—å –æ–±—Ä–∞–¥–æ–≤–∞–Ω –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø–æ–≤–∏–¥–∞—Ç—å—Å—è —Å –±–∞–±—É—à–∫–æ–π. –ö –±–∞–±—É—à–∫–µ –Ω—É–∂–Ω–æ –µ—Ö–∞—Ç—å —Ç—Ä–µ–º—è –≤–∏–¥–∞–º–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞. –†–∞–Ω—å—à–µ –æ–Ω —Å–æ–≤–µ—Ä—à–∞–ª –ø–æ–µ–∑–¥–∫–∏ —Ç–æ–ª—å–∫–æ –≤ –í–∞—à–µ–º —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–∏. –û–∫–∞–∑–∞–ª–æ—Å—å, —á—Ç–æ –æ–Ω –Ω–µ –∑–Ω–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è –æ—Å—Ç–∞–Ω–æ–≤–æ–∫, –Ω–∞ –∫–æ—Ç–æ—Ä—ã—Ö –Ω—É–∂–Ω–æ –≤—ã—Ö–æ–¥–∏—Ç—å, –ø–æ–º–Ω–∏—Ç —Ç–æ–ª—å–∫–æ, –∫–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç —É–ª–∏—Ü–∞ –∏ –¥–æ–º.
–û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ, –Ω–∞ –∫–∞–∫–æ–º —É—Ä–æ–≤–Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫? –í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∏–∑ —Å–ø–∏—Å–∫–∞:
D1
D2
D3
D4
"""
        
        test_query = """
–ó–∞–¥–∞—á–∞ ‚Äì –æ–±–µ—Å–ø–µ—á–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ –≤ —Ñ–∏–ª–∏–∞–ª–µ
–û–ª—å–≥–∞ ‚Äì –¥–∏—Ä–µ–∫—Ç–æ—Ä –∫–æ–º–ø–∞–Ω–∏–∏. –°–µ–≥–æ–¥–Ω—è –û–ª—å–≥–∞ –ø—Ä–∏–µ—Ö–∞–ª–∞ –≤ –æ–¥–∏–Ω –∏–∑ —Ñ–∏–ª–∏–∞–ª–æ–≤, –Ω–∞—à–ª–∞ —Ä—è–¥ –ø—Ä–æ–±–ª–µ–º –∏ —Ä–µ—à–∏–ª–∞ –ø–æ—Ä—É—á–∏—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä—É —Ñ–∏–ª–∏–∞–ª–∞ –ê–ª–µ–∫—Å–µ—é –Ω–∞–≤–µ—Å—Ç–∏ –ø–æ—Ä—è–¥–æ–∫. 
–û–ª—å–≥–∞ –ø–æ–¥—Ä–æ–±–Ω–æ –æ–±—ä—è—Å–Ω—è–µ—Ç –ê–ª–µ–∫—Å–µ—é, —á—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –∏ –ø—Ä–æ—Å–∏—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º –ø–æ –∫–∞–∂–¥–æ–º—É –ø—É–Ω–∫—Ç—É.  
–û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ —Å—Ç–∏–ª—å –ª–∏–¥–µ—Ä—Å—Ç–≤–∞? –í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∏–∑ —Å–ø–∏—Å–∫–∞:
S1
S2
S3
S4
"""
        
        test_query = """
–ó–∞–¥–∞—á–∞ ‚Äì —Å—Ç–∞–∂–∏—Ä–æ–≤–∫–∞ –Ω–æ–≤–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
–ï–ª–µ–Ω–∞ ‚Äì –Ω–∞—á–∞–ª—å–Ω–∏–∫ –æ–¥–Ω–æ–≥–æ –∏–∑ –æ—Ç–¥–µ–ª–æ–≤ –∫–æ–º–ø–∞–Ω–∏–∏.  –ù–∞ —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–µ –≤ –µ–µ –æ—Ç–¥–µ–ª –≤—ã—Ö–æ–¥–∏—Ç –Ω–æ–≤—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫. –û–Ω–∞ —Ö–æ—á–µ—Ç –ø–æ—Ä—É—á–∏—Ç—å –µ–≥–æ —Å—Ç–∞–∂–∏—Ä–æ–≤–∫—É –ú–∞–∫—Å–∏–º—É. –ï–ª–µ–Ω–∞ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—Ç –ú–∞–∫—Å–∏–º—É –æ –≤–∞–∂–Ω–æ—Å—Ç–∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –Ω–æ–≤—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏–º–µ–Ω–Ω–æ –¥–µ–π—Å—Ç–≤—É—é—â–∏–º–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞–º–∏, –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å –ø–ª–∞–Ω –æ–±—É—á–µ–Ω–∏—è —Å—Ç–∞–∂–µ—Ä–∞ –Ω–∞ —Ä–∞–±–æ—á–µ–º –º–µ—Å—Ç–µ, –æ–±—ä—è—Å–Ω—è–µ—Ç –ø–æ—á–µ–º—É –¥–æ–≤–µ—Ä–∏–ª–∞ –Ω–æ–≤–∏—á–∫–∞ –∏–º–µ–Ω–Ω–æ –ú–∞–∫—Å–∏–º—É.    
–û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ —Å—Ç–∏–ª—å –ª–∏–¥–µ—Ä—Å—Ç–≤–∞? –í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∏–∑ —Å–ø–∏—Å–∫–∞:
S1
S2
S3
S4
"""
        
        test_query = """
–ó–∞–¥–∞—á–∞ ‚Äì –∫–æ—Ä—Ä–µ–∫—Ü–∏—è –∑–∞–∫–∞–∑–∞ —Ä–∞—Å—Ö–æ–¥–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
–ò—Ä–∏–Ω–∞ ‚Äì –¥–∏—Ä–µ–∫—Ç–æ—Ä –∫–æ–º–ø–∞–Ω–∏–∏. –°–µ–≥–æ–¥–Ω—è –ò—Ä–∏–Ω–∞ –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è —Ä–∞—Å—á–µ—Ç–æ–º –±—é–¥–∂–µ—Ç–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –æ—Ç—á–µ—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥. –ï—Å—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–∫–∞–∑ —Ä–∞—Å—Ö–æ–¥–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤. –ò—Ä–∏–Ω–∞ —Ö–æ—á–µ—Ç –ø–æ—Ä—É—á–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫—É –∑–∞–∫–∞–∑–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ —Å–≤–æ–µ–º—É –∑–∞–≤—Ö–æ–∑—É –í–∞—Å–∏–ª–∏—é, –¥–ª—è —ç—Ç–æ–≥–æ –æ–Ω–∞ –æ–±—ä—è—Å–Ω—è–µ—Ç –í–∞—Å–∏–ª–∏—é, –∫–∞–∫ –∏–º–µ–Ω–Ω–æ —ç—Ç–æ –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å. –ó–∞—Ç–µ–º –æ–Ω–∞ –¥–∞–µ—Ç –∑–∞–¥–∞–Ω–∏–µ –í–∞—Å–∏–ª–∏—é –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –ø–æ —à–∞–≥–∞–º, –∫–∞–∫ –æ–Ω –µ–≥–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç ‚Äì –ø—Ä–∏ —ç—Ç–æ–º –∏—Å–ø—Ä–∞–≤–ª—è—è –Ω–µ–¥–æ—á–µ—Ç—ã –∏ –≤—ã—Å–∫–∞–∑—ã–≤–∞—è –æ–¥–æ–±—Ä–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –¥–µ–π—Å—Ç–≤–∏—è–º.    
–û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ —Å—Ç–∏–ª—å –ª–∏–¥–µ—Ä—Å—Ç–≤–∞? –í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∏–∑ —Å–ø–∏—Å–∫–∞:
S1
S2
S3
S4
"""
        test_query = "–ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω–æ–π –∞–≥—Ä–µ—Å—Å–∏–∏ –º–æ–∂–Ω–æ –æ—Ç–Ω–µ—Å—Ç–∏ (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä):"
        test_query = "service blueprint"

        print(f"–¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å: '{test_query}'")
        results = db.similarity_search(test_query, k=min(3, len(all_data['documents'])))

        print(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: {len(results)}")

        for i, doc in enumerate(results):
            print(f"\n   –ù–∞–π–¥–µ–Ω–Ω—ã–π —á–∞–Ω–∫ #{i+1}:")
            print(f"   –°–æ–¥–µ—Ä–∂–∏–º–æ–µ: {doc.page_content}...")
            print(f"   –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ: {doc.metadata}")
    else:
        print("‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–∏—Å–∫–∞")

except Exception as e:
    print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø–æ–∏—Å–∫–∞: {e}")

exit(0)

#retriever = db.as_retriever()
retriever = db.as_retriever(
    search_kwargs={"k": 5}  # –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 3 —á–∞–Ω–∫–∞
)
retriever_pres = db_pres.as_retriever(
    search_kwargs={"k": 3}  # –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 3 —á–∞–Ω–∫–∞
)
from langchain.retrievers import EnsembleRetriever
# –°–æ–∑–¥–∞–µ–º –∞–Ω—Å–∞–º–±–ª–µ–≤—ã–π —Ä–µ—Ç—Ä–∏–≤–µ—Ä
ensemble_retriever = EnsembleRetriever(
    retrievers=[retriever, retriever_pres],
    weights=[0.3, 0.7]  # –≤–µ—Å–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ—Ç—Ä–∏–≤–µ—Ä–∞
)


from langchain.chains import create_retrieval_chain
from langchain.chains.combine_documents import create_stuff_documents_chain
from langchain_core.prompts import ChatPromptTemplate
from langchain.callbacks.tracers import ConsoleCallbackHandler


template = """–¢—ã - —Å—Ç—É–¥–µ–Ω—Ç, —Å–¥–∞—é—â–∏–π —ç–∫–∑–∞–º–µ–Ω. –ü–µ—Ä–µ–¥ —Ç–æ–±–æ–π —Ç–µ–∫—Å—Ç, —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Å–æ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ —ç–∫—Ä–∞–Ω–∞ –º–æ–Ω–∏—Ç–æ—Ä–∞.
–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —ç–∫–∑–∞–º–µ–Ω–∞—Ü–∏–æ–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å, –æ–ø–∏—Å–∞–Ω–Ω—ã–π –≤ —Ç–µ–∫—Å—Ç–µ (–≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ).
–í–æ–∑–º–æ–∂–Ω–æ, –≤ —Ç–µ–∫—Å—Ç–µ –∫—Ä–æ–º–µ —Å–∞–º–æ–≥–æ —ç–∫–∑–∞–º–µ–Ω–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è –µ—Å—Ç—å –ø–∞—Ä–∞–∑–∏—Ç–Ω—ã–µ —Å–ª–æ–≤–∞ –∏ —Å–∏–º–≤–æ–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞–¥–æ –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å.
–≠–∫–∑–∞–º–µ–Ω–∞—Ü–∏–æ–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –í —Ç–µ–∫—Å—Ç–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–±–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤, —Ñ–æ—Ä–º—É–ª –∏ —Ç–µ—Ä–º–∏–Ω–æ–≤.
–ü—Ä–∏ –≤—ã–±–æ—Ä–µ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞ –æ–ø–∏—Ä–∞–π—Å—è –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –∫ –∑–∞–ø—Ä–æ—Å—É —Ñ–∞–π–ª–∞.
–í —Å–∞–º–æ–º –∑–∞–¥–∞–Ω–∏–∏ (–≤–æ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö) –º–æ–≥—É—Ç –±—ã—Ç—å —É–∫–∞–∑–∞–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ:
- –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏;
- –ù–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤, –∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ –∏–ª–∏ –ø—Ä–æ–Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–µ 1, 2, 3, 4, 5 –∏ —Ç.–¥. –∏–ª–∏ A, B, C, D –∏ —Ç.–¥.
–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞: –í –æ—Ç–≤–µ—Ç–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω –≤–∞–ª–∏–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ JSON —Å –¥–≤–æ–π–Ω—ã–º–∏ –∫–∞–≤—ã—á–∫–∞–º–∏.
–°—Ñ–æ—Ä–º–∏—Ä—É–π JSON —Å—Ç—Ä–æ–∫—É, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–æ–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –∏ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —ç—Ç–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞.
–í —Å–ª—É—á–∞–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫—É —Å –Ω–æ–º–µ—Ä–∞–º–∏ –æ—Ç–≤–µ—Ç–æ–≤ –∏ –∏—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã–º–∏ –æ–ø–∏—Å–∞–Ω–∏—è–º–∏.
–ù–∞–ø—Ä–∏–º–µ—Ä: –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π (–≤–µ—Ä—Ö–Ω–∏–π) –ø–æ –æ—á–µ—Ä–µ–¥–∏ –æ—Ç–≤–µ—Ç –∏–ª–∏ –æ—Ç–≤–µ—Ç –ê, –≤—ã–≤–µ–¥–∏ {{"1":"–æ–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞"}}.
–ï—Å–ª–∏ –≤—Ç–æ—Ä–æ–π –∏–ª–∏ –í –≤—ã–≤–µ–¥–∏ {{"2":"–æ–ø–∏—Å–∞–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ –æ—Ç–≤–µ—Ç–∞"}}, –∏ —Ç.–¥.
–°—Ç—Ä–æ–≥–æ, –∫–ª—é—á –º–æ–∂–µ—Ç—å –±—ã—Ç—å —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ–º, –∞ –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞ –≤ —Ç–æ—á–Ω–æ—Å—Ç–∏, –∫–∞–∫ –±—ã–ª–æ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–æ –≤ –∑–∞–¥–∞–Ω–∏–∏. –ù–µ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–π –∏ –Ω–µ –¥–æ–ø–æ–ª–Ω—è–π.
–ù–µ –¥–∞–≤–∞–π –Ω–∏–∫–∞–∫–∏—Ö –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –ï—Å–ª–∏ –ø–æ —É—Å–ª–æ–≤–∏—è–º –∑–∞–¥–∞—á–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –±–æ–ª–µ–µ –æ–¥–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞, –≤—ã–≤–µ–¥–∏ –Ω–æ–º–µ—Ä–∞ –≤—Å–µ—Ö –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤.
–ù–∞–ø—Ä–∏–º–µ—Ä: {{"1":"–æ–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞","2":"–æ–ø–∏—Å–∞–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ –æ—Ç–≤–µ—Ç–∞"}}
–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
- –í –æ—Ç–≤–µ—Ç–∞—Ö –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª–µ–µ —Å–µ–º–∏ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤. –ï—Å–ª–∏ —Ç—ã —Ä–∞—Å–ø–æ–∑–Ω–∞–ª –±–æ–ª—å—à–µ —Å–µ–º–∏ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞, –≤—ã–≤–µ–¥–∏ {{"0":"–û—à–∏–±–∫–∞"}}
- –ï—Å–ª–∏ –≤ –∑–∞–¥–∞–Ω–∏–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ, —á—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤—ã–±—Ä–∞—Ç—å –±–æ–ª–µ–µ –æ–¥–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞, –≤—Å–µ–≥–¥–∞ –≤—ã–±–∏—Ä–∞–π —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π.
- –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è –ø—É—Å—Ç–æ–π, –≤—ã–≤–µ–¥–∏ {{"0":"–û—à–∏–±–∫–∞"}}
- –ï—Å–ª–∏ –Ω–µ —É–¥–∞—ë—Ç—Å—è –Ω–∞–π—Ç–∏ –æ—Ç–≤–µ—Ç, –≤—ã–≤–µ–¥–∏ {{"0":"–û—à–∏–±–∫–∞"}}
- –ï—Å–ª–∏ –∑–∞–¥–∞–Ω–∏–µ –Ω–µ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–æ –∏–ª–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ –Ω–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é, –≤—ã–≤–µ–¥–∏ {{"0":"–û—à–∏–±–∫–∞"}}
- –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª—Å—è –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞ –±–æ–ª—å—à–µ 7 –≤—ã–≤–µ–¥–∏ {{"0":"–û—à–∏–±–∫–∞"}}

–ö–æ–Ω—Ç–µ–∫—Å—Ç: {context}

–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {input}"""

prompt = ChatPromptTemplate.from_template(template)

question_answer_chain = create_stuff_documents_chain(giga, prompt)
#rag_chain = create_retrieval_chain(retriever, question_answer_chain)
rag_chain = create_retrieval_chain(ensemble_retriever, question_answer_chain)

#q = test_query
#pure = giga.invoke([HumanMessage(content=q)]).content
#print(f"Pure: {pure}")

rag = rag_chain.invoke({"input": test_query},config={"callbacks": [ConsoleCallbackHandler()]})["answer"]
print(f"RAG: {rag}")
