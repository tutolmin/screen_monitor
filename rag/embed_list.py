import os
from chromadb.config import Settings
from langchain_gigachat.embeddings.gigachat import GigaChatEmbeddings
from langchain_chroma import Chroma

# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
if "GIGACHAT_CREDENTIALS" not in os.environ:
    print("‚ùå –û—à–∏–±–∫–∞: GIGACHAT_CREDENTIALS –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞")
    exit(1)

# –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ –∂–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–∏, —á—Ç–æ –∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±–∞–∑—ã
embeddings = GigaChatEmbeddings(
    credentials=os.environ["GIGACHAT_CREDENTIALS"],
    verify_ssl_certs=False
)

#persist_directory = "./chroma_db_p_web"
#persist_directory = "./chroma_db_p_pres"
persist_directory = "./chroma_db_u_pres"
#persist_directory = "./chroma_db_u_web"
#persist_directory = "./chroma_db_f_web"
#persist_directory = "./chroma_db_f_pres"
#persist_directory = "./chroma_db_e_web"
#persist_directory = "./chroma_db_e_pres"

# –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–∑—É
db = Chroma(
    persist_directory=persist_directory,
    embedding_function=embeddings
)

# –õ–ò–°–¢–ò–ù–ì –í–°–ï–• –ß–ê–ù–ö–û–í
print("=" * 80)
print("üìã –õ–ò–°–¢–ò–ù–ì –í–°–ï–• –ß–ê–ù–ö–û–í –í –ë–ê–ó–ï:")
print("=" * 80)

try:
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —á–∞–Ω–∫–∏ –∏–∑ –±–∞–∑—ã
    all_data = db.get()

    if all_data and 'documents' in all_data and len(all_data['documents']) > 0:
        total_chunks = len(all_data['documents'])
        print(f"‚úÖ –í—Å–µ–≥–æ —á–∞–Ω–∫–æ–≤ –≤ –±–∞–∑–µ: {total_chunks}")
        print("-" * 80)

        for i, (doc_content, metadata, doc_id) in enumerate(zip(
            all_data['documents'],
            all_data['metadatas'],
            all_data['ids']
        )):
            print(f"üéØ –ß–ê–ù–ö #{i+1}")
            print(f"   ID: {doc_id}")
            print(f"   –°–æ–¥–µ—Ä–∂–∏–º–æ–µ: {doc_content}")
            print(f"   –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ: {metadata}")
            print(f"   –î–ª–∏–Ω–∞: {len(doc_content)} —Å–∏–º–≤–æ–ª–æ–≤")
            print("-" * 80)

    else:
        print("‚ùå –í –±–∞–∑–µ –Ω–µ—Ç —á–∞–Ω–∫–æ–≤ –∏–ª–∏ –±–∞–∑–∞ –ø—É—Å—Ç–∞")

except Exception as e:
    print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —á–∞–Ω–∫–æ–≤: {e}")

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–∏—Å–∫
print("\nüîç –¢–ï–°–¢–ò–†–£–ï–ú –ü–û–ò–°–ö:")
try:
    if all_data and 'documents' in all_data and len(all_data['documents']) > 0:
        # –ë–µ—Ä–µ–º —á–∞—Å—Ç—å –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —á–∞–Ω–∫–∞ –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
#        first_chunk_content = all_data['documents'][0]
#        test_query = first_chunk_content[:50] + "..."
#        test_query = "–Ω–∞–∏–≤–Ω—ã–π"
#        test_query = "–ª—é–±–æ–∑–Ω–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å"
#        test_query = "–ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω–æ–π –∞–≥—Ä–µ—Å—Å–∏–∏ –º–æ–∂–Ω–æ –æ—Ç–Ω–µ—Å—Ç–∏ (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä):"
        test_query = """
–°–ë–ï–†
–£–ù–ò–í–ï–†–°–ò–¢–ï–¢
–°–±–µ—Ä –ú–∏–Ω–∏-–ú–í–ê 16 –ø–æ—Ç–æ–∫ –≠–∫–∑–∞–º–µ–Ω –ø–æ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–µ "–ö–æ–º–º—É
–ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω–æ–π –∞–≥—Ä–µ—Å—Å–∏–∏ –º–æ–∂–Ω–æ –æ—Ç–Ω–µ—Å—Ç–∏ (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä):
–ù–∞–ø–æ—Ä–∏—Å—Ç–æ—Å—Ç—å
–ù–µ—É—Å—Ç—É–ø—á–∏–≤–æ—Å—Ç—å
–õ—é–±–æ–∑–Ω–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
–ù–µ—Ç–µ—Ä–ø–∏–º–æ—Å—Ç—å
"""

        test_query = """
–ü–µ—Ä–µ–≥–æ–≤–æ—Ä–Ω–∞—è –∫–∞—Ä—Ç–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä):
–¢–∞–∫—Ç–∏—á–µ—Å–∫–∞—è
B
–ü–µ—Å—Ç—Ä–∞—è
–ù–∞–∏–≤–Ω–∞—è
–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è
"""

        test_query = """
–ß—Ç–æ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–Ω–æ–π —Å–∏–ª—ã (–º–Ω–æ—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä):
–°–∏–ª–∞ –∫–æ–∞–ª–∏—Ü–∏–∏
B
–°–∏–ª–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
–°–∏–ª–∞ —Å–∏—Ç—É–∞—Ü–∏–∏
D
–°–∏–ª–∞ –ª–∏—á–Ω–æ—Å—Ç–∏
–°–∏–ª–∞ –∑–¥—Ä–∞–≤–æ–≥–æ —Å–º—ã—Å–ª–∞
–°–∏–ª–∞ –¥–∞–≤–ª–µ–Ω–∏—è
"""

        test_query = """
–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –≥–∏–±–∫–æ–º—É –¥–∏–∞–ª–æ–≥—É —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä):
3-—Ö –£—Ä–æ–≤–Ω–µ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–∑–∏—Ü–∏–π
B –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–∏
–ú–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±–º–µ–Ω–æ–≤
–î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏–∏
–°–∏–º—É–ª—è—Ü–∏–∏
"""
        test_query = """
–î–ª—è —á–µ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–∏–∞–≥—Ä–∞–º–º–∞ –ò—à–∏–∫–∞–≤—ã?
"""

        test_query = """
–£–∫–∞–∂–∏—Ç–µ —Å–≤–æ–π—Å—Ç–≤–∞ —Å–∏—Å—Ç–µ–º—ã 1. –í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞.
"""

        test_query = """
–∏—Ä—Ä–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Ç–æ—Å–∫–∞
"""
        test_query = """
–ò–∑ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –Ω–∏–∂–µ –≤—ã–±–µ—Ä–∏—Ç–µ 3 –ø—Ä–∏–Ω—Ü–∏–ø–∞ –ø–æ–∏—Å–∫–∞ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π:
"""

        test_query = """
–ú–µ–∂–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –¥–∏—Å–∫–æ–Ω—Ç–∏—Ä–≤–∞–Ω–∏–µ
"""
        test_query = """
–ù–∞ –∫–∞–∫–æ–π —Å—Ö–µ–º–µ SWOT-–∞–Ω–∞–ª–∏–∑–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±–æ–∑–Ω–∞—á–µ–Ω—ã –∫–≤–∞–¥—Ä–∞–Ω—Ç—ã (–æ–±–ª–∞—Å—Ç–∏)
"""
        test_query = """
–ì–ª–∞–≤–Ω–∞—è –∑–∞–¥–∞—á–∞, —Ä–µ—à–∞–µ–º–∞—è –Ω–∞–º–∏ –ø—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–ª–æ–Ω–∫–∏ ¬´–∫–æ–Ω—Ç–µ–∫—Å—Ç¬ª –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ø—Ä–æ–±–ª–µ–º—ã —ç—Ç–æ...
"""

        test_query = """
–ò–∑ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –Ω–∏–∂–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ –ø–æ–∑–Ω–∞–≤–∞—Ç–µ–ª—å–Ω–æ–π –°–∏—Å—Ç–µ–º–µ 2
"""

        test_query = "—Ç—Ä–µ–Ω–¥—Å–ø–æ—Ç—Ç–µ—Ä"
        test_query = "ras"
        test_query = "–Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏"
        test_query = "—Å–µ—Ä–≤–∏—Å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å"
        test_query = "–∏–Ω—Å–∞–π—Ç"
        test_query = "—Ç—Ä–∏–≥–≥–µ—Ä"
        test_query = "–∞–ø–≥–∞—Ä"
        test_query = "—Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å"
        test_query = "–ß—Ç–æ —è–≤–ª—è–µ—Ç—Å—è –≤–∞–∂–Ω—ã–º–∏ —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∏–º–∏ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞ (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä):\n\n–ü–æ–ª–µ–∑–Ω–æ—Å—Ç—å\n–£–¥–æ–±—Å—Ç–≤–æ\n–ü—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω–æ—Å—Ç—å\n–ü—Ä–∏—è—Ç–Ω–æ—Å—Ç—å\n–°–∫–æ—Ä–æ—Å—Ç—å\n–ó–∞–ø–æ–º–∏–Ω–∞–µ–º–æ—Å—Ç—å"
#        test_query = "–£–¥–æ–±—Å—Ç–≤–æ\n–ü—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω–æ—Å—Ç—å\n–ü—Ä–∏—è—Ç–Ω–æ—Å—Ç—å\n–°–∫–æ—Ä–æ—Å—Ç—å\n–ó–∞–ø–æ–º–∏–Ω–∞–µ–º–æ—Å—Ç—å\n–ü–æ–ª–µ–∑–Ω–æ—Å—Ç—å\n"
        test_query = "CJM"
        test_query = "NPS"
        test_query = "EBITDA"
        test_query = "TRI"
#        test_query = "—Ä–∞–∑–≤–∏–≤–∞–µ—Ç—Å—è —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç"

        print(f"–¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å: '{test_query}'")
#        results = db.similarity_search(test_query, k=min(5, len(all_data['documents'])))

        results = db.max_marginal_relevance_search(
            test_query,
            k=5,
            fetch_k=15,
            lambda_mult=0.7
        )

        print(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: {len(results)}")

        for i, doc in enumerate(results):
            print(f"\n   –ù–∞–π–¥–µ–Ω–Ω—ã–π —á–∞–Ω–∫ #{i+1}:")
            print(f"   –°–æ–¥–µ—Ä–∂–∏–º–æ–µ: {doc.page_content}...")
            print(f"   –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ: {doc.metadata}")
    else:
        print("‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–∏—Å–∫–∞")

except Exception as e:
    print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø–æ–∏—Å–∫–∞: {e}")
