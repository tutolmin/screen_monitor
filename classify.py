import argparse
import os
import sys
from langchain_gigachat.chat_models import GigaChat
from langchain_core.prompts import ChatPromptTemplate
from langchain.callbacks.tracers import ConsoleCallbackHandler

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ —ç–∫–∑–∞–º–µ–Ω–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è –∏–∑ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞"""
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä—Å–µ—Ä–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
    parser = argparse.ArgumentParser(description='–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —ç–∫–∑–∞–º–µ–Ω–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è –∏–∑ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞ —Å –ø–æ–º–æ—â—å—é GigaChat')
    parser.add_argument('input_file', help='–ü—É—Ç—å –∫ —Ç–µ–∫—Å—Ç–æ–≤–æ–º—É —Ñ–∞–π–ª—É –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏')
    parser.add_argument('--output', '-o', help='–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)')
    
    args = parser.parse_args()
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
    if not os.path.isfile(args.input_file):
        print(f"‚ùå –û—à–∏–±–∫–∞: –§–∞–π–ª '{args.input_file}' –Ω–µ –Ω–∞–π–¥–µ–Ω")
        sys.exit(1)
    
    # –ß—Ç–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ñ–∞–π–ª–∞
    try:
        with open(args.input_file, 'r', encoding='utf-8') as file:
            text = file.read()
        print(f"‚úÖ –§–∞–π–ª '{args.input_file}' —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–Ω")
        print(f"üìÑ –†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞: {len(text)} —Å–∏–º–≤–æ–ª–æ–≤")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ '{args.input_file}': {e}")
        sys.exit(1)
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è GigaChat
    try:
        giga = GigaChat(
            credentials=os.environ["GIGACHAT_CREDENTIALS"],
            model="GigaChat-Max",
#            model="GigaChat",
            verify_ssl_certs=False,
            timeout=30,
        )
    except KeyError:
        print("‚ùå –û—à–∏–±–∫–∞: –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è GIGACHAT_CREDENTIALS")
        sys.exit(1)
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ GigaChat: {e}")
        sys.exit(1)
    
    # –ü—Ä–æ–º–ø—Ç –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
    query_extraction_prompt = ChatPromptTemplate.from_template("""
–ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–π —Ç–µ–∫—Å—Ç. –í—ã–±–µ—Ä–∏ —Ç–∏–ø –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤: 
0 - –û–ø–∏—Å–∞–Ω–∏–µ –∫–µ–π—Å–∞: –û–ø–∏—Å–∞–Ω–∏–µ –∫–µ–π—Å–∞ –∏–ª–∏ –∫–∞–∫–æ–π-—Ç–æ —Ä–∞–±–æ—á–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏;
1 - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–∫—Ç–∞: –í–æ–ø—Ä–æ—Å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –∑–Ω–∞–Ω–∏—è –∫–∞–∫–æ–≥–æ-—Ç–æ —Ñ–∞–∫—Ç–∞;
2 - –ó–∞–ø—Ä–æ—Å –Ω–∞ –∞–Ω–∞–ª–∏–∑: –ó–∞–ø—Ä–æ—Å –Ω–∞ –∞–Ω–∞–ª–∏–∑, –≤—ã–≤–µ–¥–µ–Ω–∏–µ –∏–ª–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è;

–°—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É–π –∫—Ä–∏—Ç–µ—Ä–∏—è–º –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ —Ç–µ–∫—Å—Ç–∞:
- –ö–µ–π—Å –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤ –∫–æ–Ω—Ü–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞.
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–∫—Ç–∞ - —ç—Ç–æ –æ–¥–Ω–æ—Å–ª–æ–∂–Ω–æ–µ –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.
- –ö–µ–π—Å —ç—Ç–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –±–µ–∑ –≤–æ–ø—Ä–æ—Å–∞.
- –ö–µ–π—Å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–ø–∏—Å–∞–Ω –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º. 
- –ö–µ–π—Å –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –≤ –∫–æ–Ω—Ü–µ. 
- –ö–µ–π—Å –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–Ω–∞–∫–∞ –≤–æ–ø—Ä–æ—Å–∞ –≤ –∫–æ–Ω—Ü–µ. 
- –ó–∞–ø—Ä–æ—Å –Ω–∞ –∞–Ω–∞–ª–∏–∑ —á–∞—Å—Ç–æ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–±—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –≥–ª–∞–≥–æ–ª–∞ –≤ –∫–æ–Ω—Ü–µ, –∫–∞–∫ –Ω–∞–ø—Ä–∏–º–µ—Ä "–û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ", "–ù–∞–π–¥–∏—Ç–µ", "–û—Ç–≤–µ—Ç—å—Ç–µ", "–í—ã–±–µ—Ä–∏—Ç–µ". 
- –ï—Å–ª–∏ –¥–ª—è –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å—Ç—Ä–æ–∏—Ç—å –ª–æ–≥–∏—á–µ—Å–∫—É—é —Ü–µ–ø–æ—á–∫—É –∏–ª–∏ –≤—ã–ø–æ–ª–Ω—è—Ç—å –≤—ã—á–∏—Å–ª–µ–Ω–∏—è, –∑–Ω–∞—á–∏—Ç —ç—Ç–æ –ê–Ω–∞–ª–∏–∑. 
- –ï—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —á—Ç–æ-—Ç–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ –≤—ã—á–∏—Å–ª–∏—Ç—å - —ç—Ç–æ –ê–Ω–∞–ª–∏–∑.

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞: –í –æ—Ç–≤–µ—Ç–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ JSON —Å –¥–≤–æ–π–Ω—ã–º–∏ –∫–∞–≤—ã—á–∫–∞–º–∏.
–í –∫–∞—á–µ—Å—Ç–≤–µ –∫–ª—é—á–∞ —É–∫–∞–∂–∏ —Ü–∏—Ñ—Ä—É 0 –∏–ª–∏ 1 –∏–ª–∏ 2, –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å "–∫–µ–π—Å" –∏–ª–∏ "—Ñ–∞–∫—Ç" –∏–ª–∏ "–∞–Ω–∞–ª–∏–∑"

–ù–µ –¥–∞–≤–∞–π –Ω–∏–∫–∞–∫–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏–ª–∏ –ø–æ—è—Å–Ω–µ–Ω–∏–π.

–¢–µ–∫—Å—Ç –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏: {input} """)

    # –ü—Ä–æ–º–ø—Ç –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
    query_extraction_prompt = ChatPromptTemplate.from_template("""
–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É —Ç–µ–∫—Å—Ç–æ–≤ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏—Ö —Ç—Ä–µ–Ω–∏–Ω–≥–æ–≤.
–¢–µ–±–µ –¥–∞–Ω —Ñ—Ä–∞–≥–º–µ–Ω—Ç —Ç–µ–∫—Å—Ç–∞. –û–ø—Ä–µ–¥–µ–ª–∏, –∫ –∫–∞–∫–æ–º—É —Ç–∏–ø—É –æ–Ω –æ—Ç–Ω–æ—Å–∏—Ç—Å—è:

–¢–∏–ø 1: –ü–æ–≤–µ—Å—Ç–≤–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç (Narrative) ‚Äî —Å–æ–¥–µ—Ä–∂–∏—Ç –∏—Å—Ç–æ—Ä–∏—é —Å –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–º, —Ä–∞–∑–≤–∏—Ç–∏–µ–º —Å—é–∂–µ—Ç–∞, —ç–º–æ—Ü–∏—è–º–∏, –¥–∏–∞–ª–æ–≥–∞–º–∏, –ø—Ä–∏—á–∏–Ω–Ω–æ-—Å–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ —Å–≤—è–∑—è–º–∏ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º (–∏–ª–∏ –Ω–∞–º—ë–∫–æ–º –Ω–∞ —Ä–∞–∑–≤—è–∑–∫—É). –¶–µ–ª—å ‚Äî –ø—Ä–æ–∏–ª–ª—é—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É, –ø–æ–∫–∞–∑–∞—Ç—å –¥–∏–Ω–∞–º–∏–∫—É, –≤—ã–∑–≤–∞—Ç—å –æ—Å–º—ã—Å–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –ø—Ä–∏–º–µ—Ä.

–¢–∏–ø 2: –ó–∞–¥–∞—á–∞ / –∫–µ–π—Å (Case / Quiz) ‚Äî –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –∫—Ä–∞—Ç–∫—É—é —Å–∏—Ç—É–∞—Ü–∏—é, –æ–ø–∏—Å–∞–Ω–Ω—É—é —Ñ–∞–∫—Ç–∞–º–∏, —Å —è–≤–Ω—ã–º –≤–æ–ø—Ä–æ—Å–æ–º –∏–ª–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ–º –≤—ã–±—Ä–∞—Ç—å —Ä–µ—à–µ–Ω–∏–µ/–æ—Ç–≤–µ—Ç. –ù–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–∞–∑–≤–∏—Ç–∏—è —Å—é–∂–µ—Ç–∞, —ç–º–æ—Ü–∏–π –∏–ª–∏ –¥–∏–∞–ª–æ–≥–æ–≤ –≤ –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞—Ç–µ–ª—å–Ω–æ–º —Å—Ç–∏–ª–µ. –¶–µ–ª—å ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–Ω–∞–Ω–∏–µ –∏–ª–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞/–º–æ–¥–µ–ª–∏.

–û—Ç–≤–µ—Ç—å —Å—Ç—Ä–æ–≥–æ –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º:
Narrative –∏–ª–∏ Case.

–ù–µ –æ–±—ä—è—Å–Ω—è–π, –Ω–µ –¥–æ–±–∞–≤–ª—è–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –¢–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç.     

–¢–µ–∫—Å—Ç –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏: {input} """)

    query_extraction_prompt = ChatPromptTemplate.from_template("""
–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –æ–±—É—á–∞—é—â–∏—Ö —Ç–µ–∫—Å—Ç–æ–≤ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —É–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è –∏ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è. –¢–µ–±–µ –¥–∞–Ω —Ñ—Ä–∞–≥–º–µ–Ω—Ç —Ç–µ–∫—Å—Ç–∞. –û–ø—Ä–µ–¥–µ–ª–∏ –µ–≥–æ —Ç–∏–ø –ø–æ —Å–ª–µ–¥—É—é—â–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º:

* Narrative ‚Äî –æ–±—ä–µ–º–Ω—ã–π —Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –∏—Å—Ç–æ—Ä–∏—é —Å –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–º, —ç–º–æ—Ü–∏—è–º–∏, —Ä–∞–∑–≤–∏—Ç–∏–µ–º —Å–∏—Ç—É–∞—Ü–∏–∏ –∏/–∏–ª–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–º. –î–∞–∂–µ –µ—Å–ª–∏ –≤ –∫–æ–Ω—Ü–µ –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å ‚Äî –æ–Ω –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –º–æ—Ç–∏–≤–æ–≤, –ø–æ–≤–µ–¥–µ–Ω–∏—è –∏–ª–∏ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–π, –∞ –Ω–µ –Ω–∞ –≤—ã–±–æ—Ä –æ—Ç–≤–µ—Ç–∞. –ü—Ä–∏–º–µ—Ä: –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≥–æ, –∫–∞–∫ –ú–∞—Ä–∏–Ω–∞ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–∞ —Ä–∞–±–æ—Ç–æ–π, –∫–∞–∫ –æ–Ω–∞ —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è, –∫–∞–∫ —ç—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—É –∏ –∫–ª–∏–µ–Ω—Ç–æ–≤.

* Reflective Prompt ‚Äî —Ç–µ–∫—Å—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Å–∏—Ç—É–∞—Ü–∏—é —Å –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–º –∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—ã–º –≤–æ–ø—Ä–æ—Å–æ–º, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–∑—ã–≤–∞–µ—Ç –∫ —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏, –∞–Ω–∞–ª–∏–∑—É –∏–ª–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é –º–æ–¥–µ–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–ö–∞–∫–æ–π —É—Ä–æ–≤–µ–Ω—å —Ä–∞–∑–≤–∏—Ç–∏—è –ù–∞–¥–µ–∂–¥—ã?¬ª, ¬´–ß—Ç–æ –º–µ—à–∞–µ—Ç –°–µ—Ä–≥–µ—é –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞—Ç—å?¬ª). –í–æ–ø—Ä–æ—Å –Ω–µ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç –æ–¥–Ω–æ–≥–æ ¬´–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ¬ª –æ—Ç–≤–µ—Ç–∞ ‚Äî –æ–Ω —Ç—Ä–µ–±—É–µ—Ç –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ —Ç–µ–æ—Ä–∏—é (–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —É—Ä–æ–≤–Ω–∏, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç, —Å—Ç–∏–ª–∏ –ª–∏–¥–µ—Ä—Å—Ç–≤–∞ –∏ —Ç.–ø.). –¢–µ–∫—Å—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞.

* Case/Quiz ‚Äî –∫—Ä–∞—Ç–∫–∏–π, —á–∞—Å—Ç–æ –∏–∑ –æ–¥–Ω–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, —Ç–µ–∫—Å—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Å–∏—Ç—É–∞—Ü–∏—é –∏ —è–≤–Ω–æ —Ç—Ä–µ–±—É–µ—Ç –≤—ã–±—Ä–∞—Ç—å –æ–¥–∏–Ω –∏–∑ –∑–∞—Ä–∞–Ω–µ–µ –∑–∞–¥–∞–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –¥–µ–π—Å—Ç–≤–∏—è, —Ä–µ—à–µ–Ω–∏—è –∏–ª–∏ –æ—Ç–≤–µ—Ç–∞. –ß–∞—Å—Ç–æ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ñ—Ä–∞–∑—ã: ¬´–ö–∞–∫–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π?¬ª, ¬´–ß—Ç–æ –¥–µ–ª–∞—Ç—å?¬ª, ¬´–í—ã–±–µ—Ä–∏—Ç–µ –ª—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç¬ª, –∏ –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–µ—Ç, —á—Ç–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∏–ª–∏ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π –æ—Ç–≤–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑ —Ç–µ–æ—Ä–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –∫–æ–¥–µ–∫—Å–∞ —ç—Ç–∏–∫–∏, –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∫–æ–º–ø–∞–Ω–∏–∏).

–û—Ç–≤–µ—Ç—å —Å—Ç—Ä–æ–≥–æ –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º:
Narrative
Reflective Prompt
Case/Quiz

–ù–µ –æ–±—ä—è—Å–Ω—è–π. –ù–µ –¥–æ–±–∞–≤–ª—è–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –∏–∑ —Ç—Ä—ë—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤.

–¢–µ–∫—Å—Ç –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏: {input} """)

    # –¶–µ–ø–æ—á–∫–∞ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
    query_extraction_chain = query_extraction_prompt | giga

    def extract_with_llm(input_text):
        """–ò—Å–ø–æ–ª—å–∑—É–µ—Ç LLM –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞"""
        search_query = ""
        try:
            result = query_extraction_chain.invoke(
                {"input": input_text}, 
                config={"callbacks": [ConsoleCallbackHandler()]}
            )
            search_query = result.content
            print(f"‚úÖ –ó–∞–ø—Ä–æ—Å –∫ GigaChat –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ")
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ LLM: {e}")
            return None
        return search_query

    # –ò–∑–≤–ª–µ–∫–∞–µ–º search_query
    print("üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ —Å –ø–æ–º–æ—â—å—é GigaChat...")
    search_query = extract_with_llm(text)
    
    if search_query:
        print(f"üîç –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å: '{search_query}'")
        
        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ —Ñ–∞–π–ª, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω output
        if args.output:
            try:
                with open(args.output, 'w', encoding='utf-8') as f:
                    f.write(search_query)
                print(f"üíæ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —Ñ–∞–π–ª: '{args.output}'")
            except Exception as e:
                print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª '{args.output}': {e}")
    else:
        print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å")
        sys.exit(1)

if __name__ == "__main__":
    main()
