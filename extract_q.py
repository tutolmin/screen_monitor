import argparse
import os
import sys
from langchain_gigachat.chat_models import GigaChat
from langchain_core.prompts import ChatPromptTemplate
from langchain.callbacks.tracers import ConsoleCallbackHandler

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ —ç–∫–∑–∞–º–µ–Ω–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è –∏–∑ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞"""
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä—Å–µ—Ä–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
    parser = argparse.ArgumentParser(description='–ü–∞—Ä—Å–∏–Ω–≥ —ç–∫–∑–∞–º–µ–Ω–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è –∏–∑ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞ —Å –ø–æ–º–æ—â—å—é GigaChat')
    parser.add_argument('input_file', help='–ü—É—Ç—å –∫ —Ç–µ–∫—Å—Ç–æ–≤–æ–º—É —Ñ–∞–π–ª—É –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞')
    parser.add_argument('--output', '-o', help='–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)')
    
    args = parser.parse_args()
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
    if not os.path.isfile(args.input_file):
        print(f"‚ùå –û—à–∏–±–∫–∞: –§–∞–π–ª '{args.input_file}' –Ω–µ –Ω–∞–π–¥–µ–Ω")
        sys.exit(1)
    
    # –ß—Ç–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ñ–∞–π–ª–∞
    try:
        with open(args.input_file, 'r', encoding='utf-8') as file:
            text = file.read()
        print(f"‚úÖ –§–∞–π–ª '{args.input_file}' —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–Ω")
        print(f"üìÑ –†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞: {len(text)} —Å–∏–º–≤–æ–ª–æ–≤")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ '{args.input_file}': {e}")
        sys.exit(1)
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è GigaChat
    try:
        giga = GigaChat(
            credentials=os.environ["GIGACHAT_CREDENTIALS"],
#            model="GigaChat-Max",
            model="GigaChat",
            verify_ssl_certs=False,
            timeout=30,
        )
    except KeyError:
        print("‚ùå –û—à–∏–±–∫–∞: –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è GIGACHAT_CREDENTIALS")
        sys.exit(1)
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ GigaChat: {e}")
        sys.exit(1)
    
    # –ü—Ä–æ–º–ø—Ç –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
    query_extraction_prompt = ChatPromptTemplate.from_template("""
–ü–µ—Ä–µ–¥ —Ç–æ–±–æ–π —Ç–µ–∫—Å—Ç, —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Å–æ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ (—Å–Ω–∏–º–∫–∞ —ç–∫—Ä–∞–Ω–∞).
–¢–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —ç–∫–∑–∞–º–µ–Ω–∞—Ü–∏–æ–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –æ—Ç–≤–µ—Ç–∞.
–ö—Ä–æ–º–µ —ç—Ç–æ–≥–æ –≤ —Ç–µ–∫—Å—Ç–µ –º–æ–≥—É—Ç –≤—Å—Ç—Ä–µ—á–∞—Ç—å—Å—è –≤—Å–µ–≤–æ–∑–º–æ–∂–Ω—ã–µ –ø–∞—Ä–∞–∑–∏—Ç–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω—ã –æ—à–∏–±–æ—á–Ω–æ.
–¢–∞–∫–∂–µ –≤ —Ç–µ–∫—Å—Ç–µ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã –∏–ª–∏ –ø—Ä–µ–¥–º–µ—Ç–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏.
–í–æ–∑–º–æ–∂–Ω–æ, –≤ —Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ —Ç–µ—Å—Ç—É, —Ç–∞–∫–∏–µ –∫–∞–∫ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å, –ù–∞–∑–∞–¥, –û—Ç–≤–µ—Ç–∏—Ç—å, –ó–∞–≤–µ—Ä—à–∏—Ç—å.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ –≤—ã–¥–µ–ª–∏—Ç—å –∏–∑ –≤—Å–µ–≥–æ —Ç–µ–∫—Å—Ç–∞ —Ç–æ–ª—å–∫–æ –ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —ç–∫–∑–∞–º–µ–Ω–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è –±–µ–∑ –æ—Ç–≤–µ—Ç–æ–≤.
–ù–µ –¥–æ–±–∞–≤–ª—è–π –Ω–∏–∫–∞–∫–∏—Ö –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ—è—Å–Ω–µ–Ω–∏–π –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫.

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞: –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–æ–µ —ç–∫–∑–∞–º–µ–Ω–∞—Ü–∏–æ–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ –±–µ–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞

–î–∞–ª–µ–µ –∏–¥—ë—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å: {input} """)

    # –¶–µ–ø–æ—á–∫–∞ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
    query_extraction_chain = query_extraction_prompt | giga

    def extract_with_llm(input_text):
        """–ò—Å–ø–æ–ª—å–∑—É–µ—Ç LLM –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞"""
        search_query = ""
        try:
            result = query_extraction_chain.invoke(
                {"input": input_text}, 
                config={"callbacks": [ConsoleCallbackHandler()]}
            )
            search_query = result.content
            print(f"‚úÖ –ó–∞–ø—Ä–æ—Å –∫ GigaChat –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ")
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ LLM: {e}")
            return None
        return search_query

    # –ò–∑–≤–ª–µ–∫–∞–µ–º search_query
    print("üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ —Å –ø–æ–º–æ—â—å—é GigaChat...")
    search_query = extract_with_llm(text)
    
    if search_query:
        print(f"üîç –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å: '{search_query}'")
        
        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ —Ñ–∞–π–ª, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω output
        if args.output:
            try:
                with open(args.output, 'w', encoding='utf-8') as f:
                    f.write(search_query)
                print(f"üíæ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —Ñ–∞–π–ª: '{args.output}'")
            except Exception as e:
                print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª '{args.output}': {e}")
    else:
        print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å")
        sys.exit(1)

if __name__ == "__main__":
    main()
